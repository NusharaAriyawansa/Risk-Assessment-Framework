{% extends 'base.html' %}
{% block title %}Compliance Mapping - GRC Risk Assessment{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Compliance Mapping</h1>
    <p class="subtitle">Link regulatory requirements to this risk assessment</p>
</div>

<!-- Assessment Summary -->
<div class="card highlight-card">
    <div class="card-body">
        <div class="assessment-summary">
            <div class="summary-item">
                <span class="label">Asset</span>
                <span class="value">{{ assessment.asset.name }}</span>
            </div>
            <div class="summary-item">
                <span class="label">Threat</span>
                <span class="value">{{ assessment.threat.name }}</span>
            </div>
            <div class="summary-item">
                <span class="label">Risk Score</span>
                <span class="value">
                    <span class="badge badge-{{ assessment.risk_level|lower }} large">
                        {{ assessment.risk_score }} ({{ assessment.risk_level }})
                    </span>
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Current Mappings -->
{% if assessment.compliance_requirements %}
<div class="card">
    <div class="card-header">
        <h2>Currently Linked Requirements</h2>
        <span class="count-badge">{{ assessment.compliance_requirements|length }}</span>
    </div>
    <div class="card-body">
        <div class="linked-requirements">
            {% for req in assessment.compliance_requirements %}
            <div class="linked-item">
                <div class="linked-info">
                    <span class="regulation-tag">{{ req.regulation }}</span>
                    <strong>{{ req.requirement_id }}</strong> â€” {{ req.name }}
                </div>
                <a href="{{ url_for('remove_compliance_mapping', assessment_id=assessment.id, compliance_id=req.id) }}" 
                   class="btn btn-sm btn-danger" 
                   onclick="return confirm('Remove this mapping?')">Remove</a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Add/Update Mappings -->
<div class="card">
    <div class="card-header">
        <h2>Select Compliance Requirements</h2>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('assessment_compliance', id=assessment.id) }}">
            {% set current_regulation = None %}
            {% for req in requirements %}
                {% if req.regulation != current_regulation %}
                    {% if current_regulation is not none %}
                        </div></div>
                    {% endif %}
                    {% set current_regulation = req.regulation %}
                    <div class="regulation-group">
                        <h3 class="regulation-title">
                            {% if req.regulation == 'GDPR' %}ğŸ‡ªğŸ‡º
                            {% elif req.regulation == 'HIPAA' %}ğŸ¥
                            {% elif req.regulation == 'PCI-DSS' %}ğŸ’³
                            {% else %}ğŸ“‹{% endif %}
                            {{ req.regulation }}
                        </h3>
                        <div class="requirements-list">
                {% endif %}
                
                <label class="checkbox-item {% if req.id in linked_ids %}checked{% endif %}">
                    <input type="checkbox" name="compliance_ids" value="{{ req.id }}"
                           {% if req.id in linked_ids %}checked{% endif %}>
                    <span class="checkbox-content">
                        <strong>{{ req.requirement_id }}</strong>
                        <span class="req-name">{{ req.name }}</span>
                        <span class="req-category">{{ req.category }}</span>
                    </span>
                </label>
            {% endfor %}
            {% if requirements %}
                </div></div>
            {% endif %}
            
            <div class="form-actions">
                <a href="{{ url_for('edit_assessment', id=assessment.id) }}" class="btn btn-secondary">Back to Assessment</a>
                <button type="submit" class="btn btn-primary">Save Mappings</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
