{% extends 'base.html' %}
{% block title %}Edit Assessment - GRC Risk Assessment{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Edit Risk Assessment</h1>
    <p class="subtitle">{{ assessment.asset.name }} — {{ assessment.threat.name }}</p>
</div>

<div class="card form-card">
    <div class="card-body">
        <form method="POST" action="{{ url_for('edit_assessment', id=assessment.id) }}">
            <div class="form-row">
                <div class="form-group">
                    <label>Asset</label>
                    <input type="text" value="{{ assessment.asset.name }}" disabled>
                    <input type="hidden" name="asset_id" value="{{ assessment.asset_id }}">
                </div>

                <div class="form-group">
                    <label>Threat</label>
                    <input type="text" value="{{ assessment.threat.name }}" disabled>
                    <input type="hidden" name="threat_id" value="{{ assessment.threat_id }}">
                </div>
            </div>

            <div class="risk-calculator">
                <h3>Risk Calculation</h3>
                <div class="calculator-grid">
                    <div class="form-group">
                        <label for="likelihood">Likelihood (1-5) <span class="required">*</span></label>
                        <select id="likelihood" name="likelihood" required onchange="calculateRisk()">
                            {% for i in range(1, 6) %}
                            <option value="{{ i }}" {% if assessment.likelihood == i %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="multiply-sign">×</div>

                    <div class="form-group">
                        <label for="impact">Impact (1-5) <span class="required">*</span></label>
                        <select id="impact" name="impact" required onchange="calculateRisk()">
                            {% for i in range(1, 6) %}
                            <option value="{{ i }}" {% if assessment.impact == i %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="equals-sign">=</div>

                    <div class="risk-result">
                        <label>Risk Score</label>
                        <div id="risk-score" class="score-display {{ assessment.risk_level|lower }}">{{ assessment.risk_score }}</div>
                        <div id="risk-level" class="level-display {{ assessment.risk_level|lower }}">{{ assessment.risk_level|upper }}</div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="remediation_plan">Remediation Plan</label>
                <textarea id="remediation_plan" name="remediation_plan" rows="3">{{ assessment.remediation_plan or '' }}</textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="remediation_status">Remediation Status</label>
                    <select id="remediation_status" name="remediation_status">
                        <option value="Open" {% if assessment.remediation_status == 'Open' %}selected{% endif %}>Open</option>
                        <option value="In Progress" {% if assessment.remediation_status == 'In Progress' %}selected{% endif %}>In Progress</option>
                        <option value="Closed" {% if assessment.remediation_status == 'Closed' %}selected{% endif %}>Closed</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="notes">Additional Notes</label>
                <textarea id="notes" name="notes" rows="2">{{ assessment.notes or '' }}</textarea>
            </div>

            <div class="form-actions">
                <a href="{{ url_for('report') }}" class="btn btn-secondary">Cancel</a>
                <a href="{{ url_for('assessment_compliance', id=assessment.id) }}" class="btn btn-outline">Manage Compliance</a>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
function calculateRisk() {
    const likelihood = document.getElementById('likelihood').value;
    const impact = document.getElementById('impact').value;
    const scoreDisplay = document.getElementById('risk-score');
    const levelDisplay = document.getElementById('risk-level');
    
    if (likelihood && impact) {
        const score = likelihood * impact;
        scoreDisplay.textContent = score;
        
        let level, className;
        if (score >= 20) {
            level = 'CRITICAL';
            className = 'critical';
        } else if (score >= 12) {
            level = 'HIGH';
            className = 'high';
        } else if (score >= 6) {
            level = 'MEDIUM';
            className = 'medium';
        } else {
            level = 'LOW';
            className = 'low';
        }
        
        levelDisplay.textContent = level;
        levelDisplay.className = 'level-display ' + className;
        scoreDisplay.className = 'score-display ' + className;
    }
}
</script>
{% endblock %}
