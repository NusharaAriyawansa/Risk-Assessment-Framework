{% extends 'base.html' %}
{% block title %}New Assessment - GRC Risk Assessment{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Create Risk Assessment</h1>
    <p class="subtitle">Evaluate threats against your assets using Likelihood × Impact methodology</p>
</div>

<div class="card form-card">
    <div class="card-body">
        <form method="POST" action="{{ url_for('assess') }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="asset_id">Asset <span class="required">*</span></label>
                    <select id="asset_id" name="asset_id" required>
                        <option value="">Select an asset...</option>
                        {% for asset in assets %}
                        <option value="{{ asset.id }}">{{ asset.name }} ({{ asset.criticality }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="threat_id">Threat <span class="required">*</span></label>
                    <select id="threat_id" name="threat_id" required>
                        <option value="">Select a threat...</option>
                        {% for threat in threats %}
                        <option value="{{ threat.id }}">{{ threat.name }} ({{ threat.category }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="risk-calculator">
                <h3>Risk Calculation</h3>
                <div class="calculator-grid">
                    <div class="form-group">
                        <label for="likelihood">Likelihood (1-5) <span class="required">*</span></label>
                        <select id="likelihood" name="likelihood" required onchange="calculateRisk()">
                            <option value="">Select...</option>
                            <option value="1">1 - Rare (< 10% chance)</option>
                            <option value="2">2 - Unlikely (10-30% chance)</option>
                            <option value="3">3 - Possible (30-60% chance)</option>
                            <option value="4">4 - Likely (60-90% chance)</option>
                            <option value="5">5 - Almost Certain (> 90% chance)</option>
                        </select>
                    </div>

                    <div class="multiply-sign">×</div>

                    <div class="form-group">
                        <label for="impact">Impact (1-5) <span class="required">*</span></label>
                        <select id="impact" name="impact" required onchange="calculateRisk()">
                            <option value="">Select...</option>
                            <option value="1">1 - Negligible (minimal effect)</option>
                            <option value="2">2 - Minor (small loss/disruption)</option>
                            <option value="3">3 - Moderate (significant impact)</option>
                            <option value="4">4 - Major (severe damage)</option>
                            <option value="5">5 - Catastrophic (business-ending)</option>
                        </select>
                    </div>

                    <div class="equals-sign">=</div>

                    <div class="risk-result">
                        <label>Risk Score</label>
                        <div id="risk-score" class="score-display">—</div>
                        <div id="risk-level" class="level-display"></div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="remediation_plan">Remediation Plan</label>
                <textarea id="remediation_plan" name="remediation_plan" rows="3"
                          placeholder="Describe the steps to mitigate this risk"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="remediation_status">Remediation Status</label>
                    <select id="remediation_status" name="remediation_status">
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="notes">Additional Notes</label>
                <textarea id="notes" name="notes" rows="2"
                          placeholder="Any additional context or observations"></textarea>
            </div>

            <div class="form-actions">
                <a href="{{ url_for('report') }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Create Assessment</button>
            </div>
        </form>
    </div>
</div>

<!-- Risk Matrix Reference -->
<div class="card info-card">
    <div class="card-header">
        <h3>Risk Matrix Reference</h3>
    </div>
    <div class="card-body">
        <div class="risk-matrix-reference">
            <table class="risk-matrix">
                <thead>
                    <tr>
                        <th></th>
                        <th colspan="5" class="center">Likelihood →</th>
                    </tr>
                    <tr>
                        <th>Impact ↓</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>5</strong></td>
                        <td class="medium">5</td>
                        <td class="high">10</td>
                        <td class="high">15</td>
                        <td class="critical">20</td>
                        <td class="critical">25</td>
                    </tr>
                    <tr>
                        <td><strong>4</strong></td>
                        <td class="low">4</td>
                        <td class="medium">8</td>
                        <td class="high">12</td>
                        <td class="high">16</td>
                        <td class="critical">20</td>
                    </tr>
                    <tr>
                        <td><strong>3</strong></td>
                        <td class="low">3</td>
                        <td class="medium">6</td>
                        <td class="medium">9</td>
                        <td class="high">12</td>
                        <td class="high">15</td>
                    </tr>
                    <tr>
                        <td><strong>2</strong></td>
                        <td class="low">2</td>
                        <td class="low">4</td>
                        <td class="medium">6</td>
                        <td class="medium">8</td>
                        <td class="medium">10</td>
                    </tr>
                    <tr>
                        <td><strong>1</strong></td>
                        <td class="low">1</td>
                        <td class="low">2</td>
                        <td class="low">3</td>
                        <td class="low">4</td>
                        <td class="medium">5</td>
                    </tr>
                </tbody>
            </table>
            <div class="legend">
                <span class="legend-item critical">20-25: Critical</span>
                <span class="legend-item high">12-19: High</span>
                <span class="legend-item medium">6-11: Medium</span>
                <span class="legend-item low">1-5: Low</span>
            </div>
        </div>
    </div>
</div>

<script>
function calculateRisk() {
    const likelihood = document.getElementById('likelihood').value;
    const impact = document.getElementById('impact').value;
    const scoreDisplay = document.getElementById('risk-score');
    const levelDisplay = document.getElementById('risk-level');
    
    if (likelihood && impact) {
        const score = likelihood * impact;
        scoreDisplay.textContent = score;
        
        let level, className;
        if (score >= 20) {
            level = 'CRITICAL';
            className = 'critical';
        } else if (score >= 12) {
            level = 'HIGH';
            className = 'high';
        } else if (score >= 6) {
            level = 'MEDIUM';
            className = 'medium';
        } else {
            level = 'LOW';
            className = 'low';
        }
        
        levelDisplay.textContent = level;
        levelDisplay.className = 'level-display ' + className;
        scoreDisplay.className = 'score-display ' + className;
    } else {
        scoreDisplay.textContent = '—';
        scoreDisplay.className = 'score-display';
        levelDisplay.textContent = '';
        levelDisplay.className = 'level-display';
    }
}
</script>
{% endblock %}
